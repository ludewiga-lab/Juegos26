<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>BeatMaster Pro V4</title>
    <style>
        :root {
            --bg: #050507;
            --panel: #111116;
            --accent: #00d2ff;
            --safe-top: env(safe-area-inset-top);
            --safe-bottom: env(safe-area-inset-bottom);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; touch-action: none; }

        body {
            background-color: var(--bg);
            font-family: 'Inter', system-ui, sans-serif;
            color: white;
            height: 100dvh; /* Dynamic Viewport Height para m√≥vil */
            display: flex;
            justify-content: center;
            overflow: hidden;
        }

        #app-container {
            width: 100%;
            max-width: 500px;
            height: 100%;
            padding: calc(var(--safe-top) + 10px) 15px calc(var(--safe-bottom) + 10px) 15px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        /* --- Panel Superior: Pantalla y Disco --- */
        .top-deck {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            height: 25%;
            min-height: 140px;
        }

        .screen {
            background: #000;
            border: 1px solid #333;
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 10px;
            text-align: center;
        }

        .screen h2 { font-size: clamp(10px, 3vw, 14px); color: var(--accent); letter-spacing: 2px; }
        .screen p { font-family: monospace; font-size: clamp(12px, 4vw, 18px); margin-top: 5px; color: #fff; }

        /* El Disco (Jog Wheel) */
        .jog-wheel-container {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #jog-wheel {
            width: 110px; height: 110px;
            background: radial-gradient(circle, #333 0%, #111 30%, #000 31%, #222 35%, #000 100%);
            border: 4px solid #333;
            border-radius: 50%;
            position: relative;
            box-shadow: 0 0 20px rgba(0,0,0,0.8);
            transition: transform 0.1s linear;
        }

        #jog-wheel::before {
            content: ''; position: absolute; top: 10px; left: 50%;
            width: 8px; height: 8px; background: var(--accent);
            border-radius: 50%; transform: translateX(-50%);
            box-shadow: 0 0 10px var(--accent);
        }

        /* --- Grid de 16 Pads --- */
        .pad-grid {
            flex: 1;
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            grid-template-rows: repeat(4, 1fr);
            gap: 8px;
            max-height: 45vh;
        }

        .pad {
            background: #1a1a20;
            border-radius: 8px;
            border-bottom: 3px solid #000;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 8px;
            font-weight: 800;
            color: rgba(255,255,255,0.2);
            transition: 0.05s;
        }

        .pad.active {
            transform: translateY(2px);
            border-bottom-width: 0;
            filter: brightness(1.5);
            color: white;
            box-shadow: 0 0 15px var(--accent);
        }

        /* --- Selector de Beats --- */
        .beat-selector {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            height: 60px;
        }

        .beat-btn {
            background: #222;
            border: 1px solid #444;
            border-radius: 10px;
            color: #888;
            font-size: 10px;
            font-weight: bold;
            transition: 0.2s;
        }

        .beat-btn.active {
            background: var(--accent);
            color: #000;
            border-color: #fff;
            box-shadow: 0 0 15px var(--accent);
        }

        .stop-btn {
            grid-column: span 3;
            background: #331111;
            color: #ff4444;
            border: 1px solid #441111;
            height: 40px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: bold;
        }

    </style>
</head>
<body>

<div id="app-container">
    <section class="top-deck">
        <div class="screen">
            <h2>SYSTEM ENGINE</h2>
            <p id="status-txt">READY</p>
            <div id="freq-val" style="font-size: 10px; color: #666; margin-top:5px;">FILTER: 100%</div>
        </div>
        <div class="jog-wheel-container">
            <div id="jog-wheel"></div>
        </div>
    </section>

    <div class="pad-grid" id="matrix"></div>

    <section class="beat-selector">
        <button class="beat-btn" onclick="setBeat('trap', this)">TRAP</button>
        <button class="beat-btn" onclick="setBeat('house', this)">HOUSE</button>
        <button class="beat-btn" onclick="setBeat('boom', this)">BOOM BAP</button>
        <button class="stop-btn" onclick="stopAll()">STOP ALL BEATS</button>
    </section>
</div>

<script>
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    const masterFilter = audioCtx.createBiquadFilter();
    masterFilter.type = 'lowpass';
    masterFilter.frequency.value = 20000;
    masterFilter.connect(audioCtx.destination);

    let currentLoop = null;
    let loopInterval;

    const padSounds = [
        {id:'KICK', f:60}, {id:'SUB', f:40}, {id:'BASS', f:80}, {id:'TOM', f:120},
        {id:'SNARE', f:200}, {id:'RIM', f:400}, {id:'CLAP', f:300}, {id:'HAT', f:8000},
        {id:'SYN1', f:440}, {id:'SYN2', f:554}, {id:'SYN3', f:659}, {id:'LEAD', f:880},
        {id:'FX1', f:1200}, {id:'FX2', f:2000}, {id:'FX3', f:1500}, {id:'RISER', f:3000}
    ];

    // Crear Pads
    const matrix = document.getElementById('matrix');
    padSounds.forEach((s, i) => {
        const p = document.createElement('div');
        p.className = 'pad';
        p.innerHTML = `<span>${s.id}</span>`;
        p.addEventListener('pointerdown', (e) => {
            e.preventDefault();
            playOneShot(s);
            p.classList.add('active');
            if (navigator.vibrate) navigator.vibrate(10);
        });
        p.addEventListener('pointerup', () => p.classList.remove('active'));
        matrix.appendChild(p);
    });

    function playOneShot(s) {
        if (audioCtx.state === 'suspended') audioCtx.resume();
        const now = audioCtx.currentTime;
        document.getElementById('status-txt').textContent = s.id;
        
        const osc = audioCtx.createOscillator();
        const g = audioCtx.createGain();
        osc.connect(g); g.connect(masterFilter);

        if(s.id === 'HAT') {
            playNoise(0.05); return;
        } else if(s.id.includes('KICK')) {
            osc.frequency.setValueAtTime(s.f, now);
            osc.frequency.exponentialRampToValueAtTime(0.01, now + 0.4);
            g.gain.setValueAtTime(1, now);
        } else {
            osc.type = s.id.includes('SYN') ? 'sawtooth' : 'triangle';
            osc.frequency.setValueAtTime(s.f, now);
            g.gain.setValueAtTime(0.3, now);
        }
        g.gain.exponentialRampToValueAtTime(0.01, now + 0.4);
        osc.start(); osc.stop(now + 0.4);
    }

    function playNoise(dur) {
        const buffer = audioCtx.createBuffer(1, audioCtx.sampleRate * dur, audioCtx.sampleRate);
        const data = buffer.getChannelData(0);
        for(let i=0; i<data.length; i++) data[i] = Math.random() * 2 - 1;
        const source = audioCtx.createBufferSource();
        source.buffer = buffer;
        const g = audioCtx.createGain();
        g.gain.setValueAtTime(0.1, audioCtx.currentTime);
        source.connect(g); g.connect(masterFilter);
        source.start();
    }

    // --- Control del Disco (Jog Wheel) ---
    const wheel = document.getElementById('jog-wheel');
    let lastAngle = 0;

    wheel.addEventListener('pointermove', (e) => {
        if (e.buttons > 0) {
            const rect = wheel.getBoundingClientRect();
            const x = e.clientX - (rect.left + rect.width / 2);
            const y = e.clientY - (rect.top + rect.height / 2);
            const angle = Math.atan2(y, x) * (180 / Math.PI);
            wheel.style.transform = `rotate(${angle}deg)`;
            
            // Mapeo a Filtro (0 a 20000 Hz)
            const norm = (angle + 180) / 360; 
            const freq = 200 + (norm * 19800);
            masterFilter.frequency.setTargetAtTime(freq, audioCtx.currentTime, 0.05);
            document.getElementById('freq-val').textContent = `FILTER: ${Math.round(norm * 100)}%`;
        }
    });

    // --- Sistema de 3 Beats ---
    function setBeat(type, btn) {
        stopAll();
        btn.classList.add('active');
        currentLoop = type;
        const bpm = type === 'trap' ? 140 : (type === 'house' ? 124 : 90);
        const interval = (60 / bpm) * 1000 / 2;
        let step = 0;

        loopInterval = setInterval(() => {
            const now = audioCtx.currentTime;
            if (type === 'trap') {
                if (step % 8 === 0) playOneShot({id:'KICK', f:50});
                if (step % 8 === 4) playOneShot({id:'SNARE', f:200});
                if (step % 2 === 0) playNoise(0.02);
            } else if (type === 'house') {
                if (step % 2 === 0) playOneShot({id:'KICK', f:60});
                if (step % 4 === 2) playOneShot({id:'CLAP', f:300});
                if (step % 2 === 1) playNoise(0.04);
            } else if (type === 'boom') {
                if (step % 8 === 0 || step % 8 === 6) playOneShot({id:'KICK', f:55});
                if (step % 8 === 4) playOneShot({id:'SNARE', f:180});
                if (step % 2 === 1) playNoise(0.06);
            }
            step = (step + 1) % 16;
        }, interval);
    }

    function stopAll() {
        clearInterval(loopInterval);
        document.querySelectorAll('.beat-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('status-txt').textContent = "STOPPED";
    }

    document.addEventListener('touchmove', e => e.preventDefault(), { passive: false });
</script>
</body>
</html>
