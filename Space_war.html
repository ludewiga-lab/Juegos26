<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0, viewport-fit=cover">
    <title>Aero Fighters: Elite Fixed</title>
    <style>
        :root {
            --neon-blue: #00d9ff;
            --neon-pink: #ff007b;
            --neon-orange: #ff3c00;
            --bg-dark: #050a0f;
            --safe-top: env(safe-area-inset-top, 20px);
            --safe-bottom: env(safe-area-inset-bottom, 20px);
        }

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
        }

        body {
            margin: 0;
            padding: 0;
            background: var(--bg-dark);
            color: #fff;
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            overflow: hidden;
            touch-action: none;
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100vh;
        }

        /* Contenedor Principal Adaptativo */
        #game-container {
            position: relative;
            width: 100vw;
            height: 100vh;
            max-width: 600px; /* Limite para tablets/desktop */
            display: flex;
            flex-direction: column;
            background: radial-gradient(circle at center, #0a192f 0%, #050a0f 100%);
        }

        /* UI Superior con Safe Areas */
        #ui {
            padding-top: var(--safe-top);
            padding-left: 20px;
            padding-right: 20px;
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 10px;
            z-index: 10;
            background: linear-gradient(to bottom, rgba(0,0,0,0.8), transparent);
        }

        .stat {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--neon-blue);
            text-shadow: 0 0 5px var(--neon-blue);
        }

        .stat-value {
            display: block;
            font-size: 16px;
            color: #fff;
        }

        #health-container {
            width: 100%;
            height: 6px;
            background: rgba(255,255,255,0.1);
            border-radius: 3px;
            overflow: hidden;
            margin-top: 5px;
            border: 1px solid rgba(255,255,255,0.2);
        }

        #health-bar {
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, var(--neon-pink), var(--neon-blue));
            transition: width 0.3s ease;
        }

        /* Canvas Responsivo */
        canvas {
            flex-grow: 1;
            width: 100%;
            touch-action: none;
        }

        /* Controles Modernos con Safe Areas */
        .controls {
            padding-bottom: calc(var(--safe-bottom) + 20px);
            display: flex;
            justify-content: space-evenly;
            align-items: center;
            background: linear-gradient(to top, rgba(0,0,0,0.8), transparent);
            width: 100%;
        }

        .btn {
            width: 75px;
            height: 75px;
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid var(--neon-blue);
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: var(--neon-blue);
            box-shadow: 0 0 15px rgba(0, 217, 255, 0.2);
            transition: all 0.1s ease;
            backdrop-filter: blur(5px);
        }

        .btn:active {
            transform: scale(0.9);
            background: var(--neon-blue);
            color: #000;
            box-shadow: 0 0 30px var(--neon-blue);
        }

        #fire {
            width: 90px;
            height: 90px;
            border-color: var(--neon-orange);
            color: var(--neon-orange);
            box-shadow: 0 0 15px rgba(255, 60, 0, 0.2);
        }

        #fire:active {
            background: var(--neon-orange);
            color: #fff;
        }

        .high-score-label {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 40px;
            font-weight: 900;
            color: rgba(255,255,255,0.05);
            z-index: 0;
            white-space: nowrap;
        }
    </style>
</head>
<body>

    <div id="game-container">
        <div class="high-score-label" id="bg-high-score">BEST: 0</div>
        
        <div id="ui">
            <div class="stat">Level <span id="lvl" class="stat-value">1</span></div>
            <div class="stat">Shield 
                <div id="health-container"><div id="health-bar"></div></div>
            </div>
            <div class="stat">Score <span id="score" class="stat-value">0</span></div>
        </div>

        <canvas id="game"></canvas>

        <div class="controls">
            <div id="left" class="btn">â—€</div>
            <div id="fire" class="btn">ðŸš€</div>
            <div id="right" class="btn">â–¶</div>
        </div>
    </div>

    <script>
        const canvas = document.getElementById("game");
        const ctx = canvas.getContext("2d");
        const scoreEl = document.getElementById("score");
        const highscoreEl = document.getElementById("bg-high-score");
        const healthBar = document.getElementById("health-bar");
        const lvlEl = document.getElementById("lvl");

        // Ajuste de resoluciÃ³n para pantallas de alta densidad
        function resize() {
            const dpr = window.devicePixelRatio || 1;
            const rect = canvas.getBoundingClientRect();
            canvas.width = rect.width * dpr;
            canvas.height = rect.height * dpr;
            ctx.scale(dpr, dpr);
        }
        window.addEventListener('resize', resize);
        resize();

        let score = 0;
        let highscore = localStorage.getItem("aeroHighscore") || 0;
        let level = 1;
        let health = 100;
        let weaponLvl = 1;
        let isGameOver = false;

        highscoreEl.innerText = `BEST: ${highscore}`;

        let bullets = [], enemyBullets = [], enemies = [], items = [], stars = [];
        const player = { 
            x: 0, 
            y: 0, 
            w: 44, 
            h: 44, 
            mLeft: false, 
            mRight: false,
            color: '#00d9ff'
        };

        // Inicializar posiciÃ³n jugador
        setTimeout(() => {
            player.x = (canvas.width / (window.devicePixelRatio || 1)) / 2 - 22;
            player.y = (canvas.height / (window.devicePixelRatio || 1)) - 80;
        }, 100);

        // Estrellas con efecto parallax
        for(let i=0; i<40; i++) {
            stars.push({
                x: Math.random() * 600, 
                y: Math.random() * 1000, 
                s: Math.random() * 2 + 0.5,
                o: Math.random()
            });
        }

        function drawPlane(x, y, color, isPlayer = false) {
            ctx.save();
            ctx.translate(x + 22, y + 22);
            if(!isPlayer) ctx.rotate(Math.PI);
            
            // Estilo Neon
            ctx.shadowBlur = 15;
            ctx.shadowColor = color;
            ctx.fillStyle = color;
            
            ctx.beginPath();
            ctx.moveTo(0, -22); 
            ctx.lineTo(20, 15); 
            ctx.lineTo(0, 5); 
            ctx.lineTo(-20, 15);
            ctx.closePath();
            ctx.fill();

            // Cabina
            ctx.fillStyle = "#fff";
            ctx.beginPath();
            ctx.arc(0, 0, 4, 0, Math.PI * 2);
            ctx.fill();
            
            ctx.restore();
        }

        function spawnEnemy() {
            if (enemies.length < 2 + level) {
                const w = canvas.width / (window.devicePixelRatio || 1);
                enemies.push({
                    x: Math.random() * (w - 40), 
                    y: -50,
                    speed: 1.5 + (level * 0.2),
                    sideStep: (Math.random() - 0.5) * level,
                    hp: Math.floor(level / 2) + 1,
                    color: `hsl(${(level * 60) % 360}, 80%, 60%)`
                });
            }
        }

        function shoot() {
            const cx = player.x + 20;
            const y = player.y;
            bullets.push({x: cx, y: y, vx: 0});
            if(weaponLvl >= 2) {
                bullets.push({x: player.x, y: y+10, vx: -0.5});
                bullets.push({x: player.x+40, y: y+10, vx: 0.5});
            }
        }

        function update() {
            if(isGameOver) return;

            const w = canvas.width / (window.devicePixelRatio || 1);
            const h = canvas.height / (window.devicePixelRatio || 1);

            if(player.mLeft && player.x > 0) player.x -= 6;
            if(player.mRight && player.x < w - 44) player.x += 6;

            stars.forEach(s => { 
                s.y += s.s; 
                if(s.y > h) s.y = 0; 
            });

            if(Math.random() < 0.03) spawnEnemy();

            enemies.forEach((en, i) => {
                en.y += en.speed;
                en.x += en.sideStep;
                if(en.x < 0 || en.x > w - 40) en.sideStep *= -1;
                
                if(Math.random() < 0.01) enemyBullets.push({x: en.x + 20, y: en.y + 30});
                if(en.y > h) enemies.splice(i, 1);

                // ColisiÃ³n jugador-enemigo
                if(Math.abs(en.x - player.x) < 30 && Math.abs(en.y - player.y) < 30) {
                    health -= 0.5;
                    updateUI();
                }
            });

            bullets.forEach((b, i) => {
                b.y -= 12; b.x += b.vx;
                enemies.forEach((en, j) => {
                    if(b.x > en.x && b.x < en.x+40 && b.y < en.y+40 && b.y > en.y) {
                        en.hp--; 
                        bullets.splice(i, 1);
                        if(en.hp <= 0) {
                            enemies.splice(j, 1);
                            score += 10;
                            if(score % 200 === 0) {
                                level++;
                                weaponLvl = Math.min(weaponLvl + 1, 3);
                            }
                            updateUI();
                        }
                    }
                });
                if(b.y < -20) bullets.splice(i, 1);
            });

            enemyBullets.forEach((eb, i) => {
                eb.y += 6;
                if(eb.x > player.x && eb.x < player.x+40 && eb.y > player.y && eb.y < player.y+40) {
                    health -= 10;
                    updateUI();
                    enemyBullets.splice(i, 1);
                }
                if(eb.y > h) enemyBullets.splice(i, 1);
            });

            if(health <= 0) gameOver();
        }

        function updateUI() {
            scoreEl.innerText = score;
            lvlEl.innerText = level;
            healthBar.style.width = health + "%";
            if(health < 30) healthBar.style.background = "var(--neon-pink)";
        }

        function gameOver() {
            isGameOver = true;
            if(score > highscore) {
                localStorage.setItem("aeroHighscore", score);
            }
            alert(`MISIÃ“N FALLIDA\nPuntuaciÃ³n: ${score}\nMejor: ${Math.max(score, highscore)}`);
            location.reload();
        }

        function draw() {
            const w = canvas.width / (window.devicePixelRatio || 1);
            const h = canvas.height / (window.devicePixelRatio || 1);
            
            ctx.clearRect(0, 0, w, h);

            // Estrellas
            ctx.fillStyle = "#fff";
            stars.forEach(s => {
                ctx.globalAlpha = s.o;
                ctx.fillRect(s.x % w, s.y, s.s, s.s);
            });
            ctx.globalAlpha = 1;

            drawPlane(player.x, player.y, player.color, true);
            enemies.forEach(en => drawPlane(en.x, en.y, en.color));

            // Balas Jugador (Laser neon)
            ctx.shadowBlur = 10;
            ctx.shadowColor = "yellow";
            ctx.fillStyle = "yellow";
            bullets.forEach(b => ctx.fillRect(b.x, b.y, 4, 15));

            // Balas Enemigas (Esferas de plasma)
            ctx.shadowColor = "red";
            ctx.fillStyle = varColor('--neon-pink');
            enemyBullets.forEach(eb => {
                ctx.beginPath();
                ctx.arc(eb.x, eb.y, 6, 0, Math.PI*2);
                ctx.fill();
            });
            
            ctx.shadowBlur = 0;

            update();
            requestAnimationFrame(draw);
        }

        function varColor(name) {
            return getComputedStyle(document.documentElement).getPropertyValue(name);
        }

        // Controles TÃ¡ctiles Optimizados
        const bindBtn = (id, action) => {
            const el = document.getElementById(id);
            el.addEventListener("touchstart", (e) => { 
                e.preventDefault(); 
                action(true); 
            }, {passive: false});
            el.addEventListener("touchend", (e) => { 
                e.preventDefault(); 
                action(false); 
            }, {passive: false});
        };

        bindBtn("left", (val) => player.mLeft = val);
        bindBtn("right", (val) => player.mRight = val);
        document.getElementById("fire").addEventListener("touchstart", (e) => {
            e.preventDefault();
            shoot();
        });

        draw();
    </script>
</body>
</html>