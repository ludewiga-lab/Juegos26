<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0, viewport-fit=cover">
    <title>Flappy Bird Pro</title>
    <style>
        body, html { 
            margin: 0; 
            padding: 0; 
            overflow: hidden; 
            background: #4db6ac; 
            font-family: 'Arial', sans-serif; 
            height: 100vh;
            height: 100dvh;
        }
        canvas { 
            display: block; 
            touch-action: none; 
            width: 100%; 
            height: 100%;
        }
        #ui { 
            position: absolute; 
            top: env(safe-area-inset-top, 30px); 
            width: 100%; 
            text-align: center; 
            pointer-events: none; 
            color: white; 
            text-shadow: 2px 2px 8px rgba(0,0,0,0.5); 
            z-index: 10; 
        }
        .score-box { font-size: 60px; font-weight: bold; margin: 0; }
        .high-score { font-size: 20px; opacity: 0.9; text-transform: uppercase; letter-spacing: 2px; }
        #msg { 
            position: absolute; 
            top: 60%; 
            width: 100%; 
            text-align: center; 
            color: white; 
            font-weight: bold; 
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            font-size: 20px;
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse { 0% { opacity: 0.5; } 50% { opacity: 1; } 100% { opacity: 0.5; } }
    </style>
</head>
<body>
    <div id="ui">
        <div class="high-score">Best: <span id="best">0</span></div>
        <div class="score-box" id="score">0</div>
    </div>
    <div id="msg">TOCA PARA EMPEZAR</div>
    <canvas id="game"></canvas>

    <script>
        const canvas = document.getElementById("game");
        const ctx = canvas.getContext("2d");
        const scoreEl = document.getElementById("score");
        const bestEl = document.getElementById("best");
        const msgEl = document.getElementById("msg");

        let gameState = "START"; // START, PLAYING
        let highScore = localStorage.getItem("flappy_best") || 0;
        bestEl.innerText = highScore;

        function resize() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            if (gameState === "START") {
                bird.y = canvas.height / 2;
            }
        }
        window.addEventListener('resize', resize);

        let bird = { x: 60, y: 0, radius: 14, velocity: 0, gravity: 0.4, jump: -7, flap: 0 };
        let pipes = [];
        let clouds = [];
        let score = 0;
        let frame = 0;

        // Inicializar nubes
        function initClouds() {
            clouds = [];
            for(let i=0; i<5; i++) {
                clouds.push({ x: Math.random()*window.innerWidth, y: Math.random()*window.innerHeight/2, s: 0.5 + Math.random() });
            }
        }

        function drawCloud(x, y) {
            ctx.fillStyle = "rgba(255, 255, 255, 0.8)";
            ctx.beginPath();
            ctx.arc(x, y, 20, 0, Math.PI*2);
            ctx.arc(x+15, y-10, 25, 0, Math.PI*2);
            ctx.arc(x+35, y, 20, 0, Math.PI*2);
            ctx.fill();
        }

        function drawBird() {
            ctx.save();
            ctx.translate(bird.x, bird.y);
            
            // Si estÃ¡ en espera, flota suavemente
            if (gameState === "START") {
                bird.y = (canvas.height / 2) + Math.sin(frame * 0.1) * 10;
            }

            ctx.rotate(Math.min(Math.PI/4, Math.max(-Math.PI/4, bird.velocity * 0.06)));
            
            bird.flap += 0.2;
            let wingY = Math.sin(bird.flap) * 10;
            ctx.lineWidth = 2;
            ctx.strokeStyle = "#000";

            ctx.fillStyle = "#FFD700";
            ctx.beginPath();
            ctx.ellipse(-10, wingY, 12, 8, Math.PI/4, 0, Math.PI*2);
            ctx.fill();
            ctx.stroke();

            let grad = ctx.createRadialGradient(-5, -5, 2, 0, 0, 15);
            grad.addColorStop(0, "#fff700"); grad.addColorStop(1, "#f39c12");
            ctx.fillStyle = grad;
            ctx.beginPath(); ctx.arc(0, 0, bird.radius, 0, Math.PI*2); ctx.fill();
            ctx.stroke();

            ctx.fillStyle = "white"; ctx.beginPath(); ctx.arc(7, -4, 5, 0, Math.PI*2); ctx.fill();
            ctx.fillStyle = "black"; ctx.beginPath(); ctx.arc(9, -4, 2, 0, Math.PI*2); ctx.fill();
            ctx.fillStyle = "#e67e22"; ctx.beginPath(); ctx.moveTo(12, 0); ctx.lineTo(22, 4); ctx.lineTo(12, 8); ctx.fill();
            ctx.stroke();
            
            ctx.restore();
        }

        function drawPipes() {
            pipes.forEach(p => {
                let g = ctx.createLinearGradient(p.x, 0, p.x + 55, 0);
                g.addColorStop(0, "#2ecc71"); g.addColorStop(0.5, "#a2f3a2"); g.addColorStop(1, "#27ae60");
                ctx.fillStyle = g;
                ctx.lineWidth = 2;
                
                ctx.fillRect(p.x, 0, 55, p.top);
                ctx.strokeRect(p.x, 0, 55, p.top);
                ctx.fillRect(p.x, canvas.height - p.bottom, 55, p.bottom);
                ctx.strokeRect(p.x, canvas.height - p.bottom, 55, p.bottom);
                
                if (gameState === "PLAYING") p.x -= 3;
            });
            if (pipes.length > 0 && pipes[0].x < -60) pipes.shift();
        }

        function update() {
            if (gameState === "PLAYING") {
                bird.velocity += bird.gravity;
                bird.y += bird.velocity;

                if (bird.y > canvas.height || bird.y < 0) reset();

                if (frame % 90 === 0) {
                    const gap = 160;
                    const h = Math.random() * (canvas.height - gap - 120) + 60;
                    pipes.push({ x: canvas.width, top: h, bottom: canvas.height - h - gap, passed: false });
                }

                pipes.forEach(p => {
                    if (bird.x + 10 > p.x && bird.x - 10 < p.x + 55) {
                        if (bird.y - 10 < p.top || bird.y + 10 > canvas.height - p.bottom) reset();
                    }
                    if (!p.passed && bird.x > p.x + 55) {
                        score++; p.passed = true; scoreEl.innerText = score;
                        if(score > highScore) {
                            highScore = score;
                            bestEl.innerText = highScore;
                            localStorage.setItem("flappy_best", highScore);
                        }
                    }
                });
            }

            clouds.forEach(c => {
                c.x -= c.s;
                if(c.x < -100) { c.x = canvas.width + 50; c.y = Math.random()*canvas.height/2; }
                drawCloud(c.x, c.y);
            });

            frame++;
        }

        function loop() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            let bgGrad = ctx.createLinearGradient(0,0,0, canvas.height);
            bgGrad.addColorStop(0, "#70c5ce"); bgGrad.addColorStop(1, "#4db6ac");
            ctx.fillStyle = bgGrad; ctx.fillRect(0,0, canvas.width, canvas.height);

            update();
            drawPipes();
            drawBird();
            requestAnimationFrame(loop);
        }

        function reset() {
            gameState = "START";
            msgEl.style.display = "block";
            bird.velocity = 0;
            bird.y = canvas.height / 2;
            pipes = []; score = 0; scoreEl.innerText = score;
        }

        const handleInput = (e) => { 
            e.preventDefault(); 
            if (gameState === "START") {
                gameState = "PLAYING";
                msgEl.style.display = "none";
            }
            bird.velocity = bird.jump; 
        };

        window.addEventListener("mousedown", handleInput);
        window.addEventListener("touchstart", handleInput, { passive: false });
        
        // Arrancar
        resize();
        initClouds();
        loop();
    </script>
</body>
</html>