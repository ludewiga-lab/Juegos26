<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Gravity Lab Pro</title>
    <style>
        :root { --accent: #00d2ff; --wood: #d2a679; --bounce: #ff4b91; --metal: #95a5a6; }
        body { margin: 0; background: #050505; color: white; font-family: 'Segoe UI', sans-serif; overflow: hidden; touch-action: none; }
        canvas { display: block; background: radial-gradient(circle, #151520 0%, #050505 100%); }
        
        #ui-layer { position: absolute; top: 0; width: 100%; pointer-events: none; }
        .header { background: rgba(0,0,0,0.8); padding: 10px; display: flex; justify-content: space-around; border-bottom: 2px solid #333; }
        .stat { font-weight: bold; color: var(--accent); font-size: 14px; }

        #controls { position: absolute; bottom: 0; width: 100%; background: #111; display: flex; justify-content: space-around; padding: 15px 0; border-top: 2px solid #444; }
        .tool { width: 60px; height: 50px; border: 1px solid #555; background: #222; border-radius: 5px; color: white; font-size: 9px; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .tool.active { border-color: var(--accent); background: #333; box-shadow: 0 0 10px rgba(0,210,255,0.2); }
        .icon { width: 25px; height: 6px; margin-bottom: 4px; border-radius: 2px; }

        .side-btns { position: absolute; right: 15px; bottom: 100px; display: flex; flex-direction: column; gap: 10px; }
        .btn { width: 65px; height: 65px; border-radius: 50%; border: none; color: white; font-weight: bold; font-size: 11px; box-shadow: 0 4px 15px rgba(0,0,0,0.6); }
        #play-btn { background: #2ecc71; }
        #reset-btn { background: #e74c3c; }
        #rotate-btn { background: #f39c12; display: none; }
        
        #overlay { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; display: none; pointer-events: none; }
        #overlay h1 { font-size: 40px; margin: 0; color: #ff4b4b; text-shadow: 0 0 20px rgba(0,0,0,1); }
    </style>
</head>
<body>

<div id="ui-layer">
    <div class="header">
        <span class="stat" id="lvl-txt">NIVEL 1</span>
        <span class="stat" id="inv-txt">PIEZAS: 0/3</span>
    </div>
</div>

<div id="overlay"><h1>FALLO</h1><p>Reset para editar</p></div>

<div class="side-btns">
    <button id="rotate-btn" class="btn">GIRAR</button>
    <button id="reset-btn" class="btn">LIMPIAR</button>
    <button id="play-btn" class="btn">START</button>
</div>

<div id="controls">
    <div class="tool active" onclick="setTool('wood', this)"><div class="icon" style="background:var(--wood)"></div>MADERA</div>
    <div class="tool" onclick="setTool('bounce', this)"><div class="icon" style="background:var(--bounce)"></div>GOMA</div>
    <div class="tool" onclick="setTool('metal', this)"><div class="icon" style="background:var(--metal)"></div>METAL</div>
</div>

<canvas id="gameCanvas"></canvas>

<script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
canvas.width = window.innerWidth;
canvas.height = window.innerHeight;

// Niveles con OBSTÁCULOS FIJOS (Gris Oscuro)
const levels = [
    {
        name: "Nivel 1: El Desvío", limit: 2,
        ball: {x: 50, y: 80}, goal: {x: 250, y: 550, w: 80},
        obs: [{x: 0, y: 300, w: 200, h: 20}] // Obstáculo que bloquea caída directa
    },
    {
        name: "Nivel 2: Laberinto", limit: 3,
        ball: {x: 50, y: 50}, goal: {x: 50, y: 550, w: 80},
        obs: [
            {x: 150, y: 0, w: 20, h: 400}, // Muro vertical
            {x: 150, y: 400, w: 200, h: 20} // Muro horizontal
        ]
    },
    {
        name: "Nivel 3: Precisión", limit: 4,
        ball: {x: 300, y: 50}, goal: {x: 300, y: 550, w: 60},
        obs: [
            {x: 100, y: 200, w: 300, h: 20},
            {x: 0, y: 400, w: 250, h: 20}
        ]
    }
];

let curIdx = 0;
let gameState = 'EDIT'; // EDIT, RUNNING, FAIL
let tool = 'wood';
let userParts = [];
let activePart = null;
let ball = { x: 0, y: 0, vx: 2, vy: 0, r: 10 };

const PHYSICS = { wood: 0.7, bounce: 1.5, metal: 0.1 };

function setTool(t, el) {
    tool = t;
    document.querySelectorAll('.tool').forEach(b => b.classList.remove('active'));
    el.classList.add('active');
}

document.getElementById('reset-btn').onclick = () => {
    userParts = [];
    activePart = null;
    gameState = 'EDIT';
    resetBall();
    updateUI();
};

document.getElementById('play-btn').onclick = () => {
    if (gameState === 'EDIT') {
        gameState = 'RUNNING';
        document.getElementById('play-btn').innerText = 'RESET';
    } else {
        gameState = 'EDIT';
        document.getElementById('play-btn').innerText = 'START';
        resetBall();
    }
};

document.getElementById('rotate-btn').ontouchstart = (e) => {
    e.preventDefault();
    if(activePart) activePart.angle += Math.PI / 8;
};

canvas.ontouchstart = (e) => {
    if (gameState !== 'EDIT') return;
    const t = e.touches[0];
    const l = levels[curIdx];

    let found = userParts.find(p => Math.hypot(p.x - t.clientX, p.y - t.clientY) < 40);
    if (found) {
        activePart = found;
    } else if (userParts.length < l.limit) {
        activePart = { x: t.clientX, y: t.clientY, w: 80, h: 15, angle: 0, type: tool };
        userParts.push(activePart);
    }
    document.getElementById('rotate-btn').style.display = activePart ? 'block' : 'none';
    updateUI();
};

canvas.ontouchmove = (e) => {
    if (gameState === 'EDIT' && activePart) {
        activePart.x = e.touches[0].clientX;
        activePart.y = e.touches[0].clientY;
    }
};

function resetBall() {
    const l = levels[curIdx];
    ball.x = l.ball.x;
    ball.y = l.ball.y;
    ball.vx = 2.5;
    ball.vy = 0;
    document.getElementById('overlay').style.display = 'none';
}

function updateUI() {
    const l = levels[curIdx];
    document.getElementById('lvl-txt').innerText = l.name.toUpperCase();
    document.getElementById('inv-txt').innerText = `PIEZAS: ${userParts.length}/${l.limit}`;
}

function checkCollision(p, isStatic = false) {
    let dx = ball.x - p.x;
    let dy = ball.y - p.y;
    let cos = Math.cos(-(p.angle || 0));
    let sin = Math.sin(-(p.angle || 0));
    let lx = dx * cos - dy * sin;
    let ly = dx * sin + dy * cos;

    if (lx > -p.w/2 && lx < p.w/2 && Math.abs(ly) < ball.r + p.h/2) {
        let b = isStatic ? 0.5 : PHYSICS[p.type];
        let vLx = ball.vx * cos - ball.vy * sin;
        let vLy = (ball.vx * sin + ball.vy * cos) * -b;
        ball.vx = vLx * Math.cos(p.angle || 0) - vLy * Math.sin(p.angle || 0);
        ball.vy = vLx * Math.sin(p.angle || 0) + vLy * Math.cos(p.angle || 0);
        ball.y -= 5; // Separación para evitar doble colisión
        return true;
    }
    return false;
}

function loop() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    const l = levels[curIdx];

    // Meta (Cesta)
    ctx.fillStyle = '#2ecc71';
    ctx.fillRect(l.goal.x, l.goal.y, l.goal.w, 15);

    // Obstáculos fijos (No se mueven, bloquean el paso)
    ctx.fillStyle = '#444';
    l.obs.forEach(o => {
        ctx.fillRect(o.x, o.y, o.w, o.h);
        if (gameState === 'RUNNING') checkCollision({...o, x: o.x + o.w/2, y: o.y + o.h/2}, true);
    });

    // Piezas del jugador
    userParts.forEach(p => {
        ctx.save();
        ctx.translate(p.x, p.y);
        ctx.rotate(p.angle);
        ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--' + p.type);
        if (p === activePart && gameState === 'EDIT') {
            ctx.strokeStyle = '#fff';
            ctx.lineWidth = 2;
            ctx.strokeRect(-p.w/2, -p.h/2, p.w, p.h);
        }
        ctx.fillRect(-p.w/2, -p.h/2, p.w, p.h);
        ctx.restore();
        if (gameState === 'RUNNING') checkCollision(p);
    });

    if (gameState === 'RUNNING') {
        ball.vy += 0.25;
        ball.x += ball.vx;
        ball.y += ball.vy;

        // Victoria
        if (ball.x > l.goal.x && ball.x < l.goal.x + l.goal.w && Math.abs(ball.y - l.goal.y) < 20) {
            alert("SISTEMA OPTIMIZADO: ¡Nivel superado!");
            curIdx = (curIdx + 1) % levels.length;
            userParts = [];
            gameState = 'EDIT';
            resetBall();
            updateUI();
        }

        // FALLO: La bola se detiene si sale de la pantalla
        if (ball.y > canvas.height || ball.x > canvas.width || ball.x < 0) {
            gameState = 'FAIL';
            document.getElementById('overlay').style.display = 'block';
        }
    }

    // Bola
    ctx.fillStyle = '#ff0';
    ctx.beginPath();
    ctx.arc(ball.x, ball.y, ball.r, 0, Math.PI*2);
    ctx.fill();

    requestAnimationFrame(loop);
}

resetBall();
updateUI();
loop();
</script>
</body>
</html>